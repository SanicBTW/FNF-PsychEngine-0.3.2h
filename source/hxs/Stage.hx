package hxs;

import flixel.group.FlxSpriteGroup;
import substates.GameOverSubstate;
import flixel.util.FlxColor;
import flixel.FlxG;
import flixel.system.FlxSound;
import flixel.tweens.FlxTween;
import flixel.FlxSprite;
import flixel.FlxBasic;
import hxs.ScriptHandler.ForeverModule;
import haxe.ds.StringMap;
import flixel.group.FlxGroup.FlxTypedGroup;

class Stage extends FlxTypedGroup<FlxBasic>
{
    public var module:ForeverModule;
    private var curStage:String = "stage";
	public var foreground:FlxSpriteGroup;

	public var halloweenBG:BGSprite;
	public var halloweenWhite:BGSprite;
	public var phillyCityLights:FlxTypedGroup<BGSprite>;
	public var phillyTrain:BGSprite;
	public var phillyBlack:BGSprite;
	public var phillyBlackTween:FlxTween;
	public var phillyCityLightsEvent:FlxTypedGroup<BGSprite>;
	public var phillyCityLightsEventTween:FlxTween;
	public var trainSound:FlxSound;
	public var limoKillingState:Int = 0;
	public var limo:BGSprite;
	public var limoMetalPole:BGSprite;
	public var limoLight:BGSprite;
	public var limoCorpse:BGSprite;
	public var limoCorpseTwo:BGSprite;
	public var bgLimo:BGSprite;
	public var grpLimoParticles:FlxTypedGroup<BGSprite>;
	public var grpLimoDancers:FlxTypedGroup<BackgroundDancer>;
	public var fastCar:BGSprite;
	public var upperBoppers:BGSprite;
	public var bottomBoppers:BGSprite;
	public var santa:BGSprite;
	public var heyTimer:Float;
	public var bgGirls:BackgroundGirls;
	public var wiggleShit:WiggleEffect = new WiggleEffect();
	public var bgGhouls:BGSprite;
	public var tankWatchtower:BGSprite;
	public var tankGround:BGSprite;
	public var tankmanRun:FlxTypedGroup<TankmenBG>;
	public var foregroundSprites:FlxTypedGroup<BGSprite>;

    public function new(stage:String)
    {
        super();

        this.curStage = stage;

		foreground = new FlxSpriteGroup();

        var exposure:StringMap<Dynamic> = new StringMap<Dynamic>();
        exposure.set("add", function(object:FlxBasic)
        {
            if (object is FlxSprite) cast(object, FlxSprite).antialiasing = SaveData.get(ANTIALIASING);
            add(object);
        });
		exposure.set("foreground", foreground);
        exposure.set("stage", this);
		exposure.set("curStage", this.curStage);
		exposure.set("boyfriend", PlayState.instance.boyfriend);
		exposure.set("dad", PlayState.instance.dad);
		exposure.set("dadOpponent", PlayState.instance.dad);
        module = ScriptHandler.loadModule('stages/$stage/$stage', 'stages/$stage', exposure);
		if (module != null)
		{
			if (module.exists("onCreate"))
				module.get("onCreate")();

			trace('Module Stage $stage loaded');
		}
		else // fallback to hardcoded stages
		{
			switch (curStage)
			{
				case 'stage': // Week 1
					var bg:BGSprite = new BGSprite('stageback', -600, -200, 0.9, 0.9);
					add(bg);
	
					var stageFront:BGSprite = new BGSprite('stagefront', -650, 600, 0.9, 0.9);
					stageFront.setGraphicSize(Std.int(stageFront.width * 1.1));
					stageFront.updateHitbox();
					add(stageFront);
					if (!SaveData.get(LOW_QUALITY))
					{
						var stageLight:BGSprite = new BGSprite('stage_light', -125, -100, 0.9, 0.9);
						stageLight.setGraphicSize(Std.int(stageLight.width * 1.1));
						stageLight.updateHitbox();
						add(stageLight);
						var stageLight:BGSprite = new BGSprite('stage_light', 1225, -100, 0.9, 0.9);
						stageLight.setGraphicSize(Std.int(stageLight.width * 1.1));
						stageLight.updateHitbox();
						stageLight.flipX = true;
						add(stageLight);
	
						var stageCurtains:BGSprite = new BGSprite('stagecurtains', -500, -300, 1.3, 1.3);
						stageCurtains.setGraphicSize(Std.int(stageCurtains.width * 0.9));
						stageCurtains.updateHitbox();
						add(stageCurtains);
					}
	
				case 'spooky': // Week 2
					if (!SaveData.get(LOW_QUALITY))
						halloweenBG = new BGSprite('halloween_bg', -200, -100, ['halloweem bg0', 'halloweem bg lightning strike']);
					else
						halloweenBG = new BGSprite('halloween_bg_low', -200, -100);
					add(halloweenBG);
	
					halloweenWhite = new BGSprite(null, -FlxG.width, -FlxG.height, 0, 0);
					halloweenWhite.makeGraphic(Std.int(FlxG.width * 3), Std.int(FlxG.height * 3), FlxColor.WHITE);
					halloweenWhite.alpha = 0;
					halloweenWhite.blend = ADD;
	
					// PRECACHE SOUNDS
					CoolUtil.precacheSound('thunder_1');
					CoolUtil.precacheSound('thunder_2');
	
				case 'philly': // Week 3
					if (!SaveData.get(LOW_QUALITY))
					{
						var bg:BGSprite = new BGSprite('philly/sky', -100, 0, 0.1, 0.1);
						add(bg);
					}
	
					var city:BGSprite = new BGSprite('philly/city', -10, 0, 0.3, 0.3);
					city.setGraphicSize(Std.int(city.width * 0.85));
					city.updateHitbox();
					add(city);
	
					phillyCityLights = new FlxTypedGroup<BGSprite>();
					add(phillyCityLights);
	
					for (i in 0...5)
					{
						var light:BGSprite = new BGSprite('philly/win' + i, city.x, city.y, 0.3, 0.3);
						light.visible = false;
						light.setGraphicSize(Std.int(light.width * 0.85));
						light.updateHitbox();
						phillyCityLights.add(light);
					}
	
					if (!SaveData.get(LOW_QUALITY))
					{
						var streetBehind:BGSprite = new BGSprite('philly/behindTrain', -40, 50);
						add(streetBehind);
					}
	
					phillyTrain = new BGSprite('philly/train', 2000, 360);
					add(phillyTrain);
	
					trainSound = new FlxSound().loadEmbedded(Paths.sound('train_passes'));
					CoolUtil.precacheSound('train_passes');
					FlxG.sound.list.add(trainSound);
	
					var street:BGSprite = new BGSprite('philly/street', -40, 50);
					add(street);
	
					phillyBlack = new BGSprite(null, 0, 0, 0, 0);
					phillyBlack.makeGraphic(Std.int(FlxG.width * 2), Std.int(FlxG.height * 2), FlxColor.BLACK);
					phillyBlack.alpha = 0.0;
					add(phillyBlack);
	
					phillyCityLightsEvent = new FlxTypedGroup<BGSprite>();
					add(phillyCityLightsEvent);
					for (i in 0...5)
					{
						var light:BGSprite = new BGSprite('philly/win' + i, city.x, city.y, 0.3, 0.3);
						light.visible = false;
						light.setGraphicSize(Std.int(light.width * 0.85));
						light.updateHitbox();
						phillyCityLightsEvent.add(light);
					}
	
				case 'limo': // Week 4
					var skyBG:BGSprite = new BGSprite('limo/limoSunset', -120, -50, 0.1, 0.1);
					add(skyBG);
	
					if (!SaveData.get(LOW_QUALITY))
					{
						limoMetalPole = new BGSprite('gore/metalPole', -500, 220, 0.4, 0.4);
						add(limoMetalPole);
	
						bgLimo = new BGSprite('limo/bgLimo', -150, 480, 0.4, 0.4, ['background limo pink'], true);
						add(bgLimo);
	
						limoCorpse = new BGSprite('gore/noooooo', -500, limoMetalPole.y - 130, 0.4, 0.4, ['Henchmen on rail'], true);
						add(limoCorpse);
	
						limoCorpseTwo = new BGSprite('gore/noooooo', -500, limoMetalPole.y, 0.4, 0.4, ['henchmen death'], true);
						add(limoCorpseTwo);
	
						grpLimoDancers = new FlxTypedGroup<BackgroundDancer>();
						add(grpLimoDancers);
	
						for (i in 0...5)
						{
							var dancer:BackgroundDancer = new BackgroundDancer((370 * i) + 130, bgLimo.y - 400);
							dancer.scrollFactor.set(0.4, 0.4);
							grpLimoDancers.add(dancer);
						}
	
						limoLight = new BGSprite('gore/coldHeartKiller', limoMetalPole.x - 180, limoMetalPole.y - 80, 0.4, 0.4);
						add(limoLight);
	
						grpLimoParticles = new FlxTypedGroup<BGSprite>();
						add(grpLimoParticles);
	
						// PRECACHE BLOOD
						var particle:BGSprite = new BGSprite('gore/stupidBlood', -400, -400, 0.4, 0.4, ['blood'], false);
						particle.alpha = 0.01;
						grpLimoParticles.add(particle);
						resetLimoKill();
	
						// PRECACHE SOUND
						CoolUtil.precacheSound('dancerdeath');
					}
	
					limo = new BGSprite('limo/limoDrive', -120, 550, 1, 1, ['Limo stage'], true);
	
					fastCar = new BGSprite('limo/fastCarLol', -300, 160);
					fastCar.active = true;
					limoKillingState = 0;
	
				case 'mall': // Week 5 - Cocoa, Eggnog
					var bg:BGSprite = new BGSprite('christmas/bgWalls', -1000, -500, 0.2, 0.2);
					bg.setGraphicSize(Std.int(bg.width * 0.8));
					bg.updateHitbox();
					add(bg);
	
					if (!SaveData.get(LOW_QUALITY))
					{
						upperBoppers = new BGSprite('christmas/upperBop', -240, -90, 0.33, 0.33, ['Upper Crowd Bob']);
						upperBoppers.setGraphicSize(Std.int(upperBoppers.width * 0.85));
						upperBoppers.updateHitbox();
						add(upperBoppers);
	
						var bgEscalator:BGSprite = new BGSprite('christmas/bgEscalator', -1100, -600, 0.3, 0.3);
						bgEscalator.setGraphicSize(Std.int(bgEscalator.width * 0.9));
						bgEscalator.updateHitbox();
						add(bgEscalator);
					}
	
					var tree:BGSprite = new BGSprite('christmas/christmasTree', 370, -250, 0.40, 0.40);
					add(tree);
	
					bottomBoppers = new BGSprite('christmas/bottomBop', -300, 140, 0.9, 0.9, ['Bottom Level Boppers Idle']);
					bottomBoppers.animation.addByPrefix('hey', 'Bottom Level Boppers HEY', 24, false);
					bottomBoppers.setGraphicSize(Std.int(bottomBoppers.width * 1));
					bottomBoppers.updateHitbox();
					add(bottomBoppers);
	
					var fgSnow:BGSprite = new BGSprite('christmas/fgSnow', -600, 700);
					add(fgSnow);
	
					santa = new BGSprite('christmas/santa', -840, 150, 1, 1, ['santa idle in fear']);
					add(santa);
					CoolUtil.precacheSound('Lights_Shut_off');
	
				case 'mallEvil': // Week 5 - Winter Horrorland
					var bg:BGSprite = new BGSprite('christmas/evilBG', -400, -500, 0.2, 0.2);
					bg.setGraphicSize(Std.int(bg.width * 0.8));
					bg.updateHitbox();
					add(bg);
	
					var evilTree:BGSprite = new BGSprite('christmas/evilTree', 300, -300, 0.2, 0.2);
					add(evilTree);
	
					var evilSnow:BGSprite = new BGSprite('christmas/evilSnow', -200, 700);
					add(evilSnow);
	
				case 'school': // Week 6 - Senpai, Roses
					GameOverSubstate.deathSoundName = 'fnf_loss_sfx-pixel';
					GameOverSubstate.loopSoundName = 'gameOver-pixel';
					GameOverSubstate.endSoundName = 'gameOverEnd-pixel';
					GameOverSubstate.characterName = 'bf-pixel-dead';
	
					var bgSky:BGSprite = new BGSprite('weeb/weebSky', 0, 0, 0.1, 0.1);
					add(bgSky);
					bgSky.antialiasing = false;
	
					var repositionShit = -200;
	
					var bgSchool:BGSprite = new BGSprite('weeb/weebSchool', repositionShit, 0, 0.6, 0.90);
					add(bgSchool);
					bgSchool.antialiasing = false;
	
					var bgStreet:BGSprite = new BGSprite('weeb/weebStreet', repositionShit, 0, 0.95, 0.95);
					add(bgStreet);
					bgStreet.antialiasing = false;
	
					var widShit = Std.int(bgSky.width * 6);
					if (!SaveData.get(LOW_QUALITY))
					{
						var fgTrees:BGSprite = new BGSprite('weeb/weebTreesBack', repositionShit + 170, 130, 0.9, 0.9);
						fgTrees.setGraphicSize(Std.int(widShit * 0.8));
						fgTrees.updateHitbox();
						add(fgTrees);
						fgTrees.antialiasing = false;
					}
	
					var bgTrees:FlxSprite = new FlxSprite(repositionShit - 380, -800);
					bgTrees.frames = Paths.getPackerAtlas('weeb/weebTrees');
					bgTrees.animation.add('treeLoop', [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18], 12);
					bgTrees.animation.play('treeLoop');
					bgTrees.scrollFactor.set(0.85, 0.85);
					add(bgTrees);
					bgTrees.antialiasing = false;
	
					if (!SaveData.get(LOW_QUALITY))
					{
						var treeLeaves:BGSprite = new BGSprite('weeb/petals', repositionShit, -40, 0.85, 0.85, ['PETALS ALL'], true);
						treeLeaves.setGraphicSize(widShit);
						treeLeaves.updateHitbox();
						add(treeLeaves);
						treeLeaves.antialiasing = false;
					}
	
					bgSky.setGraphicSize(widShit);
					bgSchool.setGraphicSize(widShit);
					bgStreet.setGraphicSize(widShit);
					bgTrees.setGraphicSize(Std.int(widShit * 1.4));
	
					bgSky.updateHitbox();
					bgSchool.updateHitbox();
					bgStreet.updateHitbox();
					bgTrees.updateHitbox();
	
					if (!SaveData.get(LOW_QUALITY))
					{
						bgGirls = new BackgroundGirls(-100, 190);
						bgGirls.scrollFactor.set(0.9, 0.9);
	
						if (PlayState.SONG.song.toLowerCase() == 'roses')
							bgGirls.getScared();
	
						bgGirls.setGraphicSize(Std.int(bgGirls.width * PlayState.daPixelZoom));
						bgGirls.updateHitbox();
						add(bgGirls);
					}
	
				case 'schoolEvil': // Week 6 - Thorns
					GameOverSubstate.deathSoundName = 'fnf_loss_sfx-pixel';
					GameOverSubstate.loopSoundName = 'gameOver-pixel';
					GameOverSubstate.endSoundName = 'gameOverEnd-pixel';
					GameOverSubstate.characterName = 'bf-pixel-dead';
	
					var posX = 400;
					var posY = 200;
					if (!SaveData.get(LOW_QUALITY))
					{
						var bg:BGSprite = new BGSprite('weeb/animatedEvilSchool', posX, posY, 0.8, 0.9, ['background 2'], true);
						bg.scale.set(6, 6);
						bg.antialiasing = false;
						add(bg);
	
						bgGhouls = new BGSprite('weeb/bgGhouls', -100, 190, 0.9, 0.9, ['BG freaks glitch instance'], false);
						bgGhouls.setGraphicSize(Std.int(bgGhouls.width * PlayState.daPixelZoom));
						bgGhouls.updateHitbox();
						bgGhouls.visible = false;
						bgGhouls.antialiasing = false;
						add(bgGhouls);
					}
					else
					{
						var bg:BGSprite = new BGSprite('weeb/animatedEvilSchool_low', posX, posY, 0.8, 0.9);
						bg.scale.set(6, 6);
						bg.antialiasing = false;
						add(bg);
					}
	
				case 'tank': // Week 7 - Ugh, Guns, Stress
					var sky:BGSprite = new BGSprite('tankSky', -400, -400, 0, 0);
					add(sky);
	
					if (!SaveData.get(LOW_QUALITY))
					{
						var clouds:BGSprite = new BGSprite('tankClouds', FlxG.random.int(-700, -100), FlxG.random.int(-20, 20), 0.1, 0.1);
						clouds.active = true;
						clouds.velocity.x = FlxG.random.float(5, 15);
						add(clouds);
	
						var mountains:BGSprite = new BGSprite('tankMountains', -300, -20, 0.2, 0.2);
						mountains.setGraphicSize(Std.int(1.2 * mountains.width));
						mountains.updateHitbox();
						add(mountains);
	
						var buildings:BGSprite = new BGSprite('tankBuildings', -200, 0, 0.3, 0.3);
						buildings.setGraphicSize(Std.int(1.1 * buildings.width));
						buildings.updateHitbox();
						add(buildings);
					}
	
					var ruins:BGSprite = new BGSprite('tankRuins', -200, 0, .35, .35);
					ruins.setGraphicSize(Std.int(1.1 * ruins.width));
					ruins.updateHitbox();
					add(ruins);
	
					if (!SaveData.get(LOW_QUALITY))
					{
						var smokeLeft:BGSprite = new BGSprite('smokeLeft', -200, -100, 0.4, 0.4, ['SmokeBlurLeft'], true);
						add(smokeLeft);
						var smokeRight:BGSprite = new BGSprite('smokeRight', 1100, -100, 0.4, 0.4, ['SmokeRight'], true);
						add(smokeRight);
	
						tankWatchtower = new BGSprite('tankWatchtower', 100, 50, 0.5, 0.5, ['watchtower gradient color']);
						add(tankWatchtower);
					}
	
					tankGround = new BGSprite('tankRolling', 300, 300, 0.5, 0.5, ['BG tank w lighting'], true);
					add(tankGround);
	
					tankmanRun = new FlxTypedGroup<TankmenBG>();
					add(tankmanRun);
	
					var ground:BGSprite = new BGSprite('tankGround', -420, -150);
					ground.setGraphicSize(Std.int(1.15 * ground.width));
					ground.updateHitbox();
					add(ground);
					moveTank();
	
					foregroundSprites = new FlxTypedGroup<BGSprite>();
					foregroundSprites.add(new BGSprite('tank0', -500, 650, 1.7, 1.5, ['fg']));
					if (!SaveData.get(LOW_QUALITY))
						foregroundSprites.add(new BGSprite('tank1', -300, 750, 2, 0.2, ['fg']));
					foregroundSprites.add(new BGSprite('tank2', 450, 940, 1.5, 1.5, ['foreground']));
					if (!SaveData.get(LOW_QUALITY))
						foregroundSprites.add(new BGSprite('tank4', 1300, 900, 1.5, 1.5, ['fg']));
					foregroundSprites.add(new BGSprite('tank5', 1620, 700, 1.5, 1.5, ['fg']));
					if (!SaveData.get(LOW_QUALITY))
						foregroundSprites.add(new BGSprite('tank3', 1300, 1200, 3.5, 2.5, ['fg']));
			}
		}
    }

    public function returnGFType()
    {
        var gfVersion:String = PlayState.SONG.gfVersion;
        if (gfVersion == null || gfVersion.length < 1)
        {
            switch (curStage)
			{
				case 'limo':
					gfVersion = 'gf-car';
				case 'mall' | 'mallEvil':
					gfVersion = 'gf-christmas';
				case 'school' | 'schoolEvil':
					gfVersion = 'gf-pixel';
				case 'tank':
					gfVersion = 'gf-tankmen';
				default:
					gfVersion = 'gf';
			}

			switch (Paths.formatToSongPath(PlayState.SONG.song))
			{
				case 'stress':
					gfVersion = 'pico-speaker';
			}

			PlayState.SONG.player3 = gfVersion; // Fix for the Chart Editor
        }

        return gfVersion;
    }
}